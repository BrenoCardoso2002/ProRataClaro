<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Pro Rata - BL</title>
    <link rel="icon" href="./logoProRata.jpg" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Fundo cinza claro */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Ocupa a altura total da tela */
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        /* Estilo básico para elementos interativos (botões e inputs) */
        .interactive-element {
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .interactive-element:active {
            transform: scale(0.98); /* Pequeno efeito de clique */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4 sm:p-6">

    <div class="bg-white p-8 rounded-2xl shadow-xl max-w-sm w-full text-center">
        <img
            src="./logoProRata.jpg"
            alt="Logo ProRata"
            class="w-32 h-32 mx-auto mb-6 rounded-full object-cover shadow-lg"
            onerror="this.onerror=null;this.src='https://placehold.co/128x128/cccccc/333333?text=Imagem+indisponível';"
        >

        <h1 class="text-3xl font-bold text-gray-800 mb-8">ProRata</h1>

        <div class="mb-6">
            <p class="text-gray-700 font-medium text-lg mb-2">
                Insira o valor da fatura da BL:
            </p>
            <input
                type="text"
                id="valorFatura"
                placeholder="Valor da fatura..."
                class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 interactive-element"
            >
        </div>

        <div class="mb-8">
            <p class="text-gray-700 font-medium text-lg mb-2">
                Insira a data de instalação:
            </p>
            <input
                type="text"
                id="dataInstalacao"
                placeholder="DD/MM/AAAA"
                class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 interactive-element"
            >
            <span id="dataError" class="text-red-500 text-sm mt-1 block h-4"></span>
        </div>

        <p class="text-gray-700 font-medium text-lg mb-2">
            Escolha a data de vencimento:
        </p>
        <div class="mb-8">
            <input
                type="date"
                id="dataVencimento"
                class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 interactive-element"
            >
            <span id="dueDateError" class="text-red-500 text-sm mt-1 block h-4"></span>
        </div>

        <div class="mb-8">
            <p class="text-gray-700 font-medium text-lg mb-2">
                Valor estimado de Pro Rata:
            </p>
            <p class="text-4xl font-bold text-blue-600" id="proRataValue">
                R$ XXX,xx
            </p>
        </div>

        <footer class="mt-2 pt-4 border-t border-gray-200 text-center text-gray-500 text-xs">
            <p class="mb-0">by Breno Cardoso</p>
            <p>Canal PAP INDIRETO</p>
        </footer>
    </div>

    <script>
        // Referências aos elementos HTML
        const valorFaturaInput = document.getElementById('valorFatura');
        const dataInstalacaoInput = document.getElementById('dataInstalacao');
        const dataVencimentoInput = document.getElementById('dataVencimento'); // New input
        const proRataValueDisplay = document.getElementById('proRataValue');
        const dataErrorSpan = document.getElementById('dataError');
        const dueDateErrorSpan = document.getElementById('dueDateError'); // New error span

        /**
         * Reseta o valor estimado de Pro Rata para o padrão.
         */
        function resetProRataDisplay() {
            proRataValueDisplay.innerText = 'R$ XXX,xx';
        }

        /**
         * Calcula o valor do Pro Rata com base nas entradas.
         */
        function calculateProRata() {
            resetProRataDisplay(); // Reset display before calculation

            // Pega o valor da fatura
            let valorFaturaStr = valorFaturaInput.value.replace(',', '.'); // Substitui vírgula por ponto
            const valorFatura = parseFloat(valorFaturaStr);

            // Pega a data de instalação
            const dataInstalacaoStr = dataInstalacaoInput.value;

            // Pega a data de vencimento (do novo input type="date")
            const dataVencimentoStr = dataVencimentoInput.value;

            // Valida as entradas antes de calcular
            if (isNaN(valorFatura) || valorFatura <= 0 || dataInstalacaoStr.length !== 10 || dataErrorSpan.innerText !== '' || !dataVencimentoStr) {
                return;
            }

            // Parseia a data de instalação para um objeto Date (DD/MM/AAAA)
            const partsInst = dataInstalacaoStr.split('/');
            const dayInst = parseInt(partsInst[0], 10);
            const monthInst = parseInt(partsInst[1], 10);
            const yearInst = parseInt(partsInst[2], 10);
            const instalationDate = new Date(yearInst, monthInst - 1, dayInst);

            // Parseia a data de vencimento para um objeto Date (YYYY-MM-DD from type="date")
            const partsVenc = dataVencimentoStr.split('-');
            const yearVenc = parseInt(partsVenc[0], 10);
            const monthVenc = parseInt(partsVenc[1], 10);
            const dayVenc = parseInt(partsVenc[2], 10);
            const dueDate = new Date(yearVenc, monthVenc - 1, dayVenc);

            // Clear previous due date error
            dueDateErrorSpan.innerText = '';
            dataVencimentoInput.classList.remove('border-red-500');

            // Validate if due date is before installation date
            if (dueDate < instalationDate) {
                dueDateErrorSpan.innerText = 'A data de vencimento não pode ser anterior à data de instalação.';
                dataVencimentoInput.classList.add('border-red-500');
                resetProRataDisplay();
                return;
            }

            // Calculate the difference in days
            const diffTime = dueDate.getTime() - instalationDate.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); // Difference in days

            if (diffDays < 0) {
                resetProRataDisplay();
                return;
            }

            // Calculate Pro Rata
            const proRataCalculated = (valorFatura / 30) * diffDays;

            // Format and display the result
            proRataValueDisplay.innerText = `R$ ${proRataCalculated.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        // Add event listeners for the input fields
        valorFaturaInput.addEventListener('input', function (e) {
            let value = e.target.value;

            // Remove all characters that are not numbers or comma
            value = value.replace(/[^0-9,]/g, '');

            // Allow only one comma and limit to two decimal places
            const parts = value.split(',');
            if (parts.length > 2) {
                value = parts[0] + ',' + parts.slice(1).join('');
            }
            if (parts.length === 2 && parts[1].length > 2) {
                value = parts[0] + ',' + parts[1].substring(0, 2);
            }

            e.target.value = value;
            calculateProRata(); // Calculate on input change
        });

        dataInstalacaoInput.addEventListener('input', function (e) {
            let value = e.target.value;
            dataErrorSpan.innerText = ''; // Clear previous errors
            e.target.classList.remove('border-red-500'); // Remove error border

            // Remove all characters that are not numbers
            value = value.replace(/\D/g, '');

            // Add slashes automatically
            if (value.length > 2) {
                value = value.substring(0, 2) + '/' + value.substring(2);
            }
            if (value.length > 5) {
                value = value.substring(0, 5) + '/' + value.substring(5);
            }

            // Limit the total string length to 10 characters (DD/MM/YYYY)
            if (value.length > 10) {
                value = value.substring(0, 10);
            }

            e.target.value = value;
            // Trigger calculation only if valid date is entered to avoid premature calculations
            if (value.length === 10 && dataErrorSpan.innerText === '') {
                calculateProRata();
            } else {
                resetProRataDisplay();
            }
        });

        dataInstalacaoInput.addEventListener('blur', function (e) {
            const value = e.target.value;
            dataErrorSpan.innerText = '';
            e.target.classList.remove('border-red-500');

            if (value.length === 10) {
                const parts = value.split('/');
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10);
                const year = parseInt(parts[2], 10);

                const inputDate = new Date(year, month - 1, day);

                // Check if the date is invalid (e.g., Feb 30th)
                if (isNaN(inputDate.getTime()) || inputDate.getDate() !== day || inputDate.getMonth() !== (month - 1) || inputDate.getFullYear() !== year) {
                    dataErrorSpan.innerText = 'Data inválida.';
                    e.target.classList.add('border-red-500');
                    resetProRataDisplay(); // Reset display if date is invalid
                    return;
                }

                const currentDate = new Date();
                currentDate.setHours(0, 0, 0, 0); // Zero out time for comparison
                inputDate.setHours(0, 0, 0, 0);

                const diffTime = currentDate.getTime() - inputDate.getTime();
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); // Use floor for full days difference

                // Check if date is older than 7 days; future dates are now allowed.
                if (diffDays > 7) {
                    dataErrorSpan.innerText = 'Data não pode ser mais antiga que 7 dias.';
                    e.target.classList.add('border-red-500');
                    resetProRataDisplay(); // Reset display if date is too old
                } else {
                    calculateProRata(); // Calculate if the date is valid and within range
                }
            } else if (value.length > 0) { // If something was typed but not a full date
                dataErrorSpan.innerText = 'Formato de data inválido (DD/MM/AAAA).';
                e.target.classList.add('border-red-500');
                resetProRataDisplay();
            } else { // If input is empty after blur
                resetProRataDisplay();
            }
        });

        dataVencimentoInput.addEventListener('input', calculateProRata); // Calculate on date selection
        dataVencimentoInput.addEventListener('blur', calculateProRata); // Calculate on blur
    </script>
</body>
</html>
